{"version":3,"sources":["upload_files.js"],"names":["upload_compeltely","total_images","Number","list_of_uploaded_images","length","cancelledAmount","filesAmount","setTimeout","$","fadeOut","html","text","toastr","success","get_size_container","screen_width","screen","width","container_width","modal_margin_left","container_height","init_upload_modal","window","$amazon","multiple","append","on","swal","title","type","showCancelButton","confirmButtonText","confirmButtonColor","cancelButtonText","closeOnCancel","result","hide","cropper","input","frame","urls","callback","document","ready","removeAttr","upload_images","this","prop","key","data","upload_images_to_amazons3","then","remove","Promise","resolve","reject","image_data","getCroppedCanvas","toDataURL","images","ajax","url","method","contentType","dataType","JSON","stringify","res","concat","error","files","_loop","reader","FileReader","onload","canvas","createElement","context","getContext","img","Image","height","clearRect","drawImage","base_img","Math","random","toString","substring","photo","find","crop_photo","src","readAsDataURL","i","fadeIn","image","aspectRatio","minContainerWidth","minContainerHeight","background","crop","event"],"mappings":"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","file":"upload_files.js","sourcesContent":["var cropper = {};\nvar container_width;\nvar container_height;\nvar modal_margin_left;\nvar list_of_uploaded_images = [];\nvar cancelledAmount = 0;\nvar filesAmount = 0;\n\nwindow.$amazon = {\n    input: '#amazon-upload-images',\n    multiple: true,\n    frame: 16/9,\n    type : '',\n    urls: [],\n    callback: {}\n}\n\n$(document).ready(function(){\n    // initial processing\n    get_size_container();\n    init_upload_modal();\n\n    // upload restaurant images\n    $('#amazon-upload-images').on('click', function() {\n        if(!window.$amazon.multiple) $('#amazon-upload-images').removeAttr('multiple');\n    });\n    $('#amazon-upload-images').on('change', function() {\n        cropper = {};\n        list_of_uploaded_images = [];\n        cancelledAmount = 0;\n        filesAmount = 0;\n        if(!window.$amazon.multiple) $('#amazon-upload-images').removeAttr('multiple');\n        upload_images(this);\n    });\n    $('#modal-upload-images').on('click','.submit-image',function(){\n        $(this).prop('disabled', true);\n        $(this).text('Uploading...');\n        let key = $(this).data('key');\n        upload_images_to_amazons3(key).then((success)=>{\n            window.$amazon.callback[$amazon.type]();\n        });\n        \n    })\n    $('#modal-upload-images').on('click','.cancel-image',function(){\n        let key = $(this).data('key');\n        $(`#image-${key}`).remove();\n        cancelledAmount ++;\n        $('#number-of-cancelled-images').text(`Cancelled: ${cancelledAmount}/${filesAmount}`);\n        upload_compeltely();        \n    })\n})\n\n// ------------------------------------------------------------\n\nvar upload_images_to_amazons3 = function(key){\n    return new Promise((resolve, reject)=>{\n        let image_data = cropper[key].getCroppedCanvas().toDataURL('image/jpeg');\n        let data = {\n            images: [image_data]\n        }\n        $.ajax({\n            url: '/upload-images-to-amazons3',\n            method: 'POST',\n            contentType: 'application/json; charset=utf-8',\n            dataType: 'json',\n            data: JSON.stringify(data),\n        })\n        .then((res)=> {\n            window.$amazon.urls = res.data;\n            list_of_uploaded_images = list_of_uploaded_images.concat(res.data);\n            $('#number-of-uploaded-images').text(`Uploaded: ${list_of_uploaded_images.length}/${filesAmount}`);\n            let html = `\n                <img src=\"${image_data}\" style=\"width: 100px !important; display:inline-block;margin-left: 10%\">\n                <p class=\"h4\" style=\"display:inline-block; color: green;\"><i class=\"fa fa-check fa-2x\" aria-hidden=\"true\"></i></p>\n            `;\n            $(`#image-${key}`).html(html);\n            upload_compeltely()\n            return resolve(res.data)\n        })\n        .catch((error)=>{\n            return reject(error)\n        })\n    })\n}\n\nfunction upload_compeltely(){\n    let total_images = Number(list_of_uploaded_images.length) + Number(cancelledAmount);\n    if(total_images != Number(filesAmount)) return false;\n    setTimeout(function(){\n        $('#modal-upload-images').fadeOut();\n        $('#list-of-uploaded-images').html('');\n        $('#number-of-uploaded-images').text('');\n        $('#number-of-cancelled-images').text('');\n        if(toastr) toastr.success('Upload completely');\n    }, 1000)\n}\n\nfunction get_size_container(){\n    let screen_width = screen.width;\n    if(screen_width < 500){\n        container_width = screen_width * 0.8;\n        modal_margin_left = 10;\n    }else{\n        container_width = screen_width * 0.5;\n        modal_margin_left = 20;\n    }  \n    container_height =   container_width * 9 / 16;\n}\n\nfunction init_upload_modal(){\n    let html = `\n        <div class=\"row col-xs-12 col-sm-12 col-md-12\" style=\"display: none;\">\n            <input type=\"file\" id=\"amazon-upload-images\" ${window.$amazon.multiple ? 'multiple' : ''}>\n        </div>\n        <div id=\"modal-upload-images\" style=\"position: fixed; display: none; width: 100%; height: 100%; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999;cursor: pointer;overflow-y: auto;\">\n            <div \n                style=\"\n                        background-color: white;\n                        margin-top: 5%; \n                        margin-left: ${modal_margin_left}%; \n                        margin-bottom: 5%; \n                        width: ${100-modal_margin_left*2}%; \n                        padding: 10px;\n                        border-radius: 25px;\n                        box-shadow: 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);\n                    \"\n                class=\"center-block\">\n                <div class=\"form-row form-group\">\n                    <p class=\"h3\" id=\"number-of-uploaded-images\" style=\"font-weight: bold; color: green ;display: inline-block; margin-top: 35px; margin-left: 20px;\"></p>\n                    <p class=\"h3\" id=\"number-of-cancelled-images\" style=\"font-weight: bold; color: red ;display: inline-block; margin-top: 35px; margin-left: 20px;\"></p>\n                    <p class=\"h3 float-right\" id=\"close-upload-modal\" style=\"margin-right: 5%; color: red; display: inline-block\"><i class=\"fa fa-times fa-2x\" aria-hidden=\"true\"></i></p>\n                </div>\n                <div id=\"list-of-uploaded-images\">\n\n                </div>\n            </div>\n        </div>\n    `;\n    $('body').append(html);\n    $('#close-upload-modal').on('click',function(){\n        swal({\n            title: \"Are you sure to cancel to upload all images?\",\n            html: true,\n            text: `This action only cancel the images that aren't uploaded.`,\n            type: \"warning\",\n            showCancelButton: true,\n            confirmButtonText: \"Ok\",\n            confirmButtonColor: \"#3cb371\",\n            cancelButtonText: \"No\",\n            closeOnCancel: true\n        }, function (result) {\n            if (result) {\n                $('#list-of-uploaded-images').html('');\n                $('#number-of-uploaded-images').text('');\n                $('#number-of-cancelled-images').text('');\n                $('#modal-upload-images').hide();   \n            }\n        });\n    })\n}\n\nvar upload_images = function(input) {\n    if (!input.files) return false;\n    filesAmount = input.files.length;\n    for (var i = 0; i < filesAmount; i++) {\n            let reader = new FileReader();\n            reader.onload = function() {\n\n                let canvas = document.createElement(\"canvas\");\n                let context = canvas.getContext('2d');\n                let img = new Image();\n    \n                img.onload = function() {\n                    if(img.width < img.height){\n                        canvas.width = 480;\n                        canvas.height = 720;\n                    }else{\n                        canvas.width = 720;\n                        canvas.height = 480;\n                    }\n                    context.clearRect(0, 0, canvas.width, canvas.height);\n                    context.drawImage(img, 0, 0, canvas.width, canvas.height);\n                    let base_img = canvas.toDataURL('image/jpeg', 1);\n                    let key = Math.random().toString(36).substring(2);\n                    let html = `\n                            <div class=\"form-row\" id=\"image-${key}\" style=\"padding-top: 20px; padding-bottom: 20px;border-top: 5px solid grey;\">\n                                <div class=\"form-row col-xs-12 col-sm-12 col-md-12\">\n                                    <div style=\"width: ${container_width}px; height: ${container_height}px; margin: auto;\" >\n                                        <img id=\"upload-image-${key}\" style=\"width: 100%;\" src=\"${base_img}\">\n                                    <div>\n                                </div>\n                                <div class=\"form-row col-xs-12 col-sm-12 col-md-12\" style=\"padding-top: 20px\">\n                                    <div class=\"col-xs-6 col-sm-6 col-md-6\">\n                                        <button type=\"button\" class=\"btn btn-danger cancel-image\" data-key=\"${key}\" style=\"display: inline-block\">Cancel</button>\n                                    </div>\n                                    <div class=\"col-xs-6 col-sm-6 col-md-6\">\n                                        <button type=\"button\" class=\"btn btn-success float-right submit-image\" data-key=\"${key}\" style=\"display: inline-block\">Submit</button>\n                                    </div>\n                                </div>\n                            </div>\n                    `;\n                    $('#list-of-uploaded-images').append(html);\n                    let photo = $('#list-of-uploaded-images').find(`#upload-image-${key}`);\n                    crop_photo(photo, key);\n                }\n                img.src = reader.result;\n            }\n            reader.readAsDataURL(input.files[i]);\n    }\n    $('#modal-upload-images').fadeIn();\n};\n\nconst crop_photo = function(image, key){\n    image.cropper({\n        aspectRatio: window.$amazon.frame || 16/9,\n        minContainerWidth: container_width,\n        minContainerHeight: container_height,\n        background: false,\n        crop: function(event) {\n            // console.log(event);\n        },\n    });\n    cropper[key] = image.data('cropper');\n}\n"]}